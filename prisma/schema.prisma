// ZirakBook Accounting System - Database Schema
// Phase 1: Core Foundation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  SUPERADMIN
  COMPANY_ADMIN
  ACCOUNTANT
  MANAGER
  SALES_USER
  PURCHASE_USER
  INVENTORY_USER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum ProductType {
  GOODS
  SERVICE
  BUNDLE
}

enum StockMovementType {
  PURCHASE
  SALE
  ADJUSTMENT
  TRANSFER
  RETURN
  OPENING_STOCK
}

enum TransactionType {
  DEBIT
  CREDIT
}

enum DocumentStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SENT
  RECEIVED
  COMPLETED
  CANCELLED
  VOID
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
  CREDIT_CARD
  DEBIT_CARD
  UPI
  WALLET
  OTHER
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

// ==================== CORE TABLES ====================

model Company {
  id                String    @id @default(uuid())
  name              String
  email             String?
  phone             String?
  address           String?
  city              String?
  state             String?
  country           String    @default("India")
  postalCode        String?
  taxNumber         String?   // GST/VAT Number
  registrationNo    String?
  logo              String?
  baseCurrency      String    @default("INR")
  fiscalYearStart   DateTime  @default(now())
  fiscalYearEnd     DateTime?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  users             User[]
  accounts          Account[]
  customers         Customer[]
  vendors           Vendor[]
  products          Product[]
  categories        Category[]
  brands            Brand[]
  warehouses        Warehouse[]
  purchaseQuotations PurchaseQuotation[]
  purchaseOrders    PurchaseOrder[]
  goodsReceipts     GoodsReceipt[]
  bills             Bill[]
  purchaseReturns   PurchaseReturn[]
  salesQuotations   SalesQuotation[]
  salesOrders       SalesOrder[]
  deliveryChallans  DeliveryChallan[]
  invoices          Invoice[]
  salesReturns      SalesReturn[]
  payments          Payment[]
  receipts          Receipt[]
  journalEntries    JournalEntry[]

  @@index([email])
  @@index([taxNumber])
}

model User {
  id                String      @id @default(uuid())
  companyId         String
  email             String      @unique
  password          String      // Hashed with bcrypt
  name              String
  phone             String?
  role              UserRole    @default(VIEWER)
  status            UserStatus  @default(ACTIVE)
  avatar            String?
  lastLoginAt       DateTime?
  passwordChangedAt DateTime?
  emailVerified     Boolean     @default(false)
  emailVerifiedAt   DateTime?
  twoFactorEnabled  Boolean     @default(false)
  twoFactorSecret   String?
  refreshToken      String?     @db.Text
  resetPasswordToken String?
  resetPasswordExpires DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  createdBy         String?

  // Relations
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  permissions       UserPermission[]
  auditLogs         AuditLog[]

  @@index([companyId])
  @@index([email])
  @@index([role])
  @@index([status])
}

model Permission {
  id          String   @id @default(uuid())
  module      String   // e.g., "inventory", "sales", "purchase", "accounts"
  action      String   // e.g., "create", "read", "update", "delete", "approve"
  resource    String   // e.g., "products", "invoices", "reports"
  description String?
  createdAt   DateTime @default(now())

  // Relations
  users       UserPermission[]

  @@unique([module, action, resource])
  @@index([module])
}

model UserPermission {
  id           String     @id @default(uuid())
  userId       String
  permissionId String
  granted      Boolean    @default(true)
  grantedAt    DateTime   @default(now())
  grantedBy    String?

  // Relations
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

// ==================== ACCOUNTS MODULE ====================

model Account {
  id              String        @id @default(uuid())
  companyId       String
  accountNumber   String        // e.g., "1000", "2000"
  accountName     String
  accountType     AccountType
  parentId        String?       // For hierarchical accounts
  description     String?
  isActive        Boolean       @default(true)
  openingBalance  Decimal       @default(0) @db.Decimal(15, 2)
  currentBalance  Decimal       @default(0) @db.Decimal(15, 2)
  currency        String        @default("INR")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       String?

  // Relations
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent          Account?      @relation("AccountHierarchy", fields: [parentId], references: [id])
  children        Account[]     @relation("AccountHierarchy")
  journalLines    JournalLine[]

  @@unique([companyId, accountNumber])
  @@index([companyId])
  @@index([accountType])
  @@index([parentId])
}

model Customer {
  id              String    @id @default(uuid())
  companyId       String
  customerNumber  String    // Auto-generated: CUST-0001
  name            String
  email           String?
  phone           String?
  address         String?
  city            String?
  state           String?
  country         String    @default("India")
  postalCode      String?
  taxNumber       String?   // GST/VAT Number
  creditLimit     Decimal   @default(0) @db.Decimal(15, 2)
  creditDays      Int       @default(30)
  openingBalance  Decimal   @default(0) @db.Decimal(15, 2)
  currentBalance  Decimal   @default(0) @db.Decimal(15, 2)
  isActive        Boolean   @default(true)
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String?

  // Relations
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  salesQuotations SalesQuotation[]
  salesOrders     SalesOrder[]
  deliveryChallans DeliveryChallan[]
  invoices        Invoice[]
  salesReturns    SalesReturn[]
  receipts        Receipt[]

  @@unique([companyId, customerNumber])
  @@index([companyId])
  @@index([email])
  @@index([phone])
}

model Vendor {
  id              String    @id @default(uuid())
  companyId       String
  vendorNumber    String    // Auto-generated: VEND-0001
  name            String
  email           String?
  phone           String?
  address         String?
  city            String?
  state           String?
  country         String    @default("India")
  postalCode      String?
  taxNumber       String?   // GST/VAT Number
  paymentTerms    Int       @default(30)  // Days
  openingBalance  Decimal   @default(0) @db.Decimal(15, 2)
  currentBalance  Decimal   @default(0) @db.Decimal(15, 2)
  isActive        Boolean   @default(true)
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String?

  // Relations
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  purchaseQuotations PurchaseQuotation[]
  purchaseOrders  PurchaseOrder[]
  goodsReceipts   GoodsReceipt[]
  bills           Bill[]
  purchaseReturns PurchaseReturn[]
  payments        Payment[]

  @@unique([companyId, vendorNumber])
  @@index([companyId])
  @@index([email])
  @@index([phone])
}

// ==================== INVENTORY MODULE ====================

model Category {
  id          String    @id @default(uuid())
  companyId   String
  name        String
  description String?
  parentId    String?   // For sub-categories
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  @@index([companyId])
  @@index([parentId])
}

model Brand {
  id          String    @id @default(uuid())
  companyId   String
  name        String
  description String?
  logo        String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products    Product[]

  @@index([companyId])
}

model Product {
  id              String        @id @default(uuid())
  companyId       String
  sku             String        // Stock Keeping Unit
  name            String
  description     String?       @db.Text
  type            ProductType   @default(GOODS)
  categoryId      String?
  brandId         String?
  barcode         String?
  unit            String        @default("PCS")  // PCS, KG, LTR, etc.
  purchasePrice   Decimal       @default(0) @db.Decimal(15, 2)
  sellingPrice    Decimal       @default(0) @db.Decimal(15, 2)
  mrp             Decimal       @default(0) @db.Decimal(15, 2)
  taxRate         Decimal       @default(0) @db.Decimal(5, 2)  // GST/VAT %
  hsnCode         String?       // Harmonized System Nomenclature
  sacCode         String?       // Service Accounting Code
  reorderLevel    Int           @default(0)
  minStockLevel   Int           @default(0)
  maxStockLevel   Int           @default(0)
  images          String[]      // Array of image URLs
  isActive        Boolean       @default(true)
  isSaleable      Boolean       @default(true)
  isPurchasable   Boolean       @default(true)
  trackInventory  Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       String?

  // Relations
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category        Category?     @relation(fields: [categoryId], references: [id])
  brand           Brand?        @relation(fields: [brandId], references: [id])
  stock           Stock[]
  stockMovements  StockMovement[]
  purchaseQuotationItems PurchaseQuotationItem[]
  purchaseOrderItems PurchaseOrderItem[]
  goodsReceiptItems GoodsReceiptItem[]
  billItems       BillItem[]
  purchaseReturnItems PurchaseReturnItem[]
  salesQuotationItems SalesQuotationItem[]
  salesOrderItems SalesOrderItem[]
  deliveryChallanItems DeliveryChallanItem[]
  invoiceItems    InvoiceItem[]
  salesReturnItems SalesReturnItem[]

  @@unique([companyId, sku])
  @@index([companyId])
  @@index([categoryId])
  @@index([brandId])
  @@index([barcode])
}

model Warehouse {
  id          String    @id @default(uuid())
  companyId   String
  code        String    // e.g., WH-01
  name        String
  address     String?
  city        String?
  state       String?
  country     String    @default("India")
  postalCode  String?
  phone       String?
  email       String?
  isActive    Boolean   @default(true)
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  stock       Stock[]
  stockMovements StockMovement[]
  goodsReceipts GoodsReceipt[]

  @@unique([companyId, code])
  @@index([companyId])
}

model Stock {
  id            String    @id @default(uuid())
  companyId     String    // Denormalized for faster queries
  productId     String
  warehouseId   String
  quantity      Int       @default(0)
  reservedQty   Int       @default(0)  // Reserved for orders
  availableQty  Int       @default(0)  // quantity - reservedQty
  valueAmount   Decimal   @default(0) @db.Decimal(15, 2)  // Total value at cost
  lastUpdated   DateTime  @default(now()) @updatedAt

  // Relations
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse     Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([productId, warehouseId])
  @@index([productId])
  @@index([warehouseId])
  @@index([companyId])
}

model StockMovement {
  id              String            @id @default(uuid())
  companyId       String
  productId       String
  warehouseId     String
  movementType    StockMovementType
  referenceType   String?           // e.g., "PURCHASE_ORDER", "SALES_ORDER"
  referenceId     String?           // ID of the related document
  referenceNumber String?           // Document number for display
  quantity        Int
  unitPrice       Decimal           @default(0) @db.Decimal(15, 2)
  totalValue      Decimal           @default(0) @db.Decimal(15, 2)
  balanceAfter    Int               // Stock balance after this movement
  notes           String?           @db.Text
  movementDate    DateTime          @default(now())
  createdAt       DateTime          @default(now())
  createdBy       String?

  // Relations
  product         Product   @relation(fields: [productId], references: [id])
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])

  @@index([companyId])
  @@index([productId])
  @@index([warehouseId])
  @@index([referenceType, referenceId])
  @@index([movementDate])
}

// ==================== PURCHASE MODULE ====================

model PurchaseQuotation {
  id              String            @id @default(uuid())
  companyId       String
  vendorId        String
  quotationNumber String
  quotationDate   DateTime          @default(now())
  validTill       DateTime?
  referenceNo     String?
  subtotal        Decimal           @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal           @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal           @default(0) @db.Decimal(15, 2)
  total           Decimal           @default(0) @db.Decimal(15, 2)
  status          DocumentStatus    @default(DRAFT)
  notes           String?           @db.Text
  terms           String?           @db.Text
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?
  approvedBy      String?
  approvedAt      DateTime?

  // Relations
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor          Vendor            @relation(fields: [vendorId], references: [id])
  items           PurchaseQuotationItem[]

  @@unique([companyId, quotationNumber])
  @@index([companyId])
  @@index([vendorId])
  @@index([quotationDate])
  @@index([status])
}

model PurchaseQuotationItem {
  id              String            @id @default(uuid())
  quotationId     String
  productId       String
  description     String?
  quantity        Decimal           @db.Decimal(15, 3)
  unitPrice       Decimal           @db.Decimal(15, 2)
  taxRate         Decimal           @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal           @default(0) @db.Decimal(15, 2)
  amount          Decimal           @db.Decimal(15, 2)

  // Relations
  quotation       PurchaseQuotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  product         Product           @relation(fields: [productId], references: [id])

  @@index([quotationId])
  @@index([productId])
}

model PurchaseOrder {
  id              String            @id @default(uuid())
  companyId       String
  vendorId        String
  orderNumber     String
  orderDate       DateTime          @default(now())
  expectedDeliveryDate DateTime?
  quotationId     String?           // Link to quotation if converted
  subtotal        Decimal           @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal           @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal           @default(0) @db.Decimal(15, 2)
  total           Decimal           @default(0) @db.Decimal(15, 2)
  status          DocumentStatus    @default(DRAFT)
  notes           String?           @db.Text
  terms           String?           @db.Text
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?
  approvedBy      String?
  approvedAt      DateTime?

  // Relations
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor          Vendor            @relation(fields: [vendorId], references: [id])
  items           PurchaseOrderItem[]
  goodsReceipts   GoodsReceipt[]
  bills           Bill[]

  @@unique([companyId, orderNumber])
  @@index([companyId])
  @@index([vendorId])
  @@index([orderDate])
  @@index([status])
}

model PurchaseOrderItem {
  id              String            @id @default(uuid())
  orderId         String
  productId       String
  description     String?
  quantity        Decimal           @db.Decimal(15, 3)
  receivedQty     Decimal           @default(0) @db.Decimal(15, 3)
  unitPrice       Decimal           @db.Decimal(15, 2)
  taxRate         Decimal           @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal           @default(0) @db.Decimal(15, 2)
  amount          Decimal           @db.Decimal(15, 2)

  // Relations
  order           PurchaseOrder     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product           @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model GoodsReceipt {
  id              String            @id @default(uuid())
  companyId       String
  vendorId        String
  receiptNumber   String
  receiptDate     DateTime          @default(now())
  purchaseOrderId String?
  warehouseId     String
  vehicleNo       String?
  driverName      String?
  driverPhone     String?
  subtotal        Decimal           @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal           @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal           @default(0) @db.Decimal(15, 2)
  total           Decimal           @default(0) @db.Decimal(15, 2)
  status          DocumentStatus    @default(DRAFT)
  notes           String?           @db.Text
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?

  // Relations
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor          Vendor            @relation(fields: [vendorId], references: [id])
  purchaseOrder   PurchaseOrder?    @relation(fields: [purchaseOrderId], references: [id])
  warehouse       Warehouse         @relation(fields: [warehouseId], references: [id])
  items           GoodsReceiptItem[]

  @@unique([companyId, receiptNumber])
  @@index([companyId])
  @@index([vendorId])
  @@index([purchaseOrderId])
  @@index([receiptDate])
}

model GoodsReceiptItem {
  id              String        @id @default(uuid())
  receiptId       String
  productId       String
  description     String?
  orderedQty      Decimal       @default(0) @db.Decimal(15, 3)
  receivedQty     Decimal       @db.Decimal(15, 3)
  acceptedQty     Decimal       @db.Decimal(15, 3)
  rejectedQty     Decimal       @default(0) @db.Decimal(15, 3)
  damagedQty      Decimal       @default(0) @db.Decimal(15, 3)
  unitPrice       Decimal       @db.Decimal(15, 2)
  taxRate         Decimal       @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal       @default(0) @db.Decimal(15, 2)
  amount          Decimal       @db.Decimal(15, 2)

  // Relations
  receipt         GoodsReceipt  @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  product         Product       @relation(fields: [productId], references: [id])

  @@index([receiptId])
  @@index([productId])
}

model Bill {
  id              String        @id @default(uuid())
  companyId       String
  vendorId        String
  billNumber      String
  billDate        DateTime      @default(now())
  dueDate         DateTime?
  purchaseOrderId String?
  subtotal        Decimal       @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal       @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal       @default(0) @db.Decimal(15, 2)
  total           Decimal       @default(0) @db.Decimal(15, 2)
  paidAmount      Decimal       @default(0) @db.Decimal(15, 2)
  balanceAmount   Decimal       @default(0) @db.Decimal(15, 2)
  paymentStatus   PaymentStatus @default(PENDING)
  status          DocumentStatus @default(DRAFT)
  notes           String?       @db.Text
  terms           String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       String?

  // Relations
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor          Vendor        @relation(fields: [vendorId], references: [id])
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  items           BillItem[]
  payments        Payment[]

  @@unique([companyId, billNumber])
  @@index([companyId])
  @@index([vendorId])
  @@index([billDate])
  @@index([dueDate])
  @@index([paymentStatus])
}

model BillItem {
  id              String    @id @default(uuid())
  billId          String
  productId       String
  description     String?
  quantity        Decimal   @db.Decimal(15, 3)
  unitPrice       Decimal   @db.Decimal(15, 2)
  taxRate         Decimal   @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal   @default(0) @db.Decimal(15, 2)
  amount          Decimal   @db.Decimal(15, 2)

  // Relations
  bill            Bill      @relation(fields: [billId], references: [id], onDelete: Cascade)
  product         Product   @relation(fields: [productId], references: [id])

  @@index([billId])
  @@index([productId])
}

model PurchaseReturn {
  id              String        @id @default(uuid())
  companyId       String
  vendorId        String
  returnNumber    String
  returnDate      DateTime      @default(now())
  billId          String?
  reason          String?       @db.Text
  subtotal        Decimal       @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal       @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal       @default(0) @db.Decimal(15, 2)
  total           Decimal       @default(0) @db.Decimal(15, 2)
  refundAmount    Decimal       @default(0) @db.Decimal(15, 2)
  status          DocumentStatus @default(DRAFT)
  notes           String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       String?
  approvedBy      String?
  approvedAt      DateTime?

  // Relations
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor          Vendor        @relation(fields: [vendorId], references: [id])
  items           PurchaseReturnItem[]

  @@unique([companyId, returnNumber])
  @@index([companyId])
  @@index([vendorId])
  @@index([returnDate])
}

model PurchaseReturnItem {
  id              String        @id @default(uuid())
  returnId        String
  productId       String
  description     String?
  quantity        Decimal       @db.Decimal(15, 3)
  returnReason    String?
  unitPrice       Decimal       @db.Decimal(15, 2)
  taxRate         Decimal       @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal       @default(0) @db.Decimal(15, 2)
  amount          Decimal       @db.Decimal(15, 2)

  // Relations
  purchaseReturn  PurchaseReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)
  product         Product        @relation(fields: [productId], references: [id])

  @@index([returnId])
  @@index([productId])
}

// ==================== SALES MODULE ====================

model SalesQuotation {
  id              String            @id @default(uuid())
  companyId       String
  customerId      String
  quotationNumber String
  quotationDate   DateTime          @default(now())
  validTill       DateTime?
  referenceNo     String?
  shippingAddress String?           @db.Text
  subtotal        Decimal           @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal           @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal           @default(0) @db.Decimal(15, 2)
  total           Decimal           @default(0) @db.Decimal(15, 2)
  status          DocumentStatus    @default(DRAFT)
  notes           String?           @db.Text
  terms           String?           @db.Text
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?

  // Relations
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer          @relation(fields: [customerId], references: [id])
  items           SalesQuotationItem[]
  salesOrders     SalesOrder[]

  @@unique([companyId, quotationNumber])
  @@index([companyId])
  @@index([customerId])
  @@index([quotationDate])
  @@index([status])
}

model SalesQuotationItem {
  id              String        @id @default(uuid())
  quotationId     String
  productId       String
  description     String?
  quantity        Decimal       @db.Decimal(15, 3)
  unitPrice       Decimal       @db.Decimal(15, 2)
  taxRate         Decimal       @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal       @default(0) @db.Decimal(15, 2)
  amount          Decimal       @db.Decimal(15, 2)

  // Relations
  quotation       SalesQuotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  product         Product        @relation(fields: [productId], references: [id])

  @@index([quotationId])
  @@index([productId])
}

model SalesOrder {
  id              String            @id @default(uuid())
  companyId       String
  customerId      String
  orderNumber     String
  orderDate       DateTime          @default(now())
  deliveryDate    DateTime?
  quotationId     String?
  shippingAddress String?           @db.Text
  subtotal        Decimal           @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal           @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal           @default(0) @db.Decimal(15, 2)
  total           Decimal           @default(0) @db.Decimal(15, 2)
  status          DocumentStatus    @default(DRAFT)
  notes           String?           @db.Text
  terms           String?           @db.Text
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?

  // Relations
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer          @relation(fields: [customerId], references: [id])
  quotation       SalesQuotation?   @relation(fields: [quotationId], references: [id])
  items           SalesOrderItem[]
  deliveryChallans DeliveryChallan[]
  invoices        Invoice[]

  @@unique([companyId, orderNumber])
  @@index([companyId])
  @@index([customerId])
  @@index([quotationId])
  @@index([orderDate])
  @@index([status])
}

model SalesOrderItem {
  id              String     @id @default(uuid())
  orderId         String
  productId       String
  description     String?
  quantity        Decimal    @db.Decimal(15, 3)
  deliveredQty    Decimal    @default(0) @db.Decimal(15, 3)
  unitPrice       Decimal    @db.Decimal(15, 2)
  taxRate         Decimal    @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal    @default(0) @db.Decimal(15, 2)
  amount          Decimal    @db.Decimal(15, 2)

  // Relations
  order           SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product    @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model DeliveryChallan {
  id              String            @id @default(uuid())
  companyId       String
  customerId      String
  challanNumber   String
  challanDate     DateTime          @default(now())
  salesOrderId    String?
  shippingAddress String?           @db.Text
  vehicleNo       String?
  driverName      String?
  driverPhone     String?
  transportMode   String?
  subtotal        Decimal           @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal           @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal           @default(0) @db.Decimal(15, 2)
  total           Decimal           @default(0) @db.Decimal(15, 2)
  status          DocumentStatus    @default(DRAFT)
  notes           String?           @db.Text
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?

  // Relations
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer          @relation(fields: [customerId], references: [id])
  salesOrder      SalesOrder?       @relation(fields: [salesOrderId], references: [id])
  items           DeliveryChallanItem[]
  invoices        Invoice[]

  @@unique([companyId, challanNumber])
  @@index([companyId])
  @@index([customerId])
  @@index([salesOrderId])
  @@index([challanDate])
}

model DeliveryChallanItem {
  id              String          @id @default(uuid())
  challanId       String
  productId       String
  description     String?
  quantity        Decimal         @db.Decimal(15, 3)
  unitPrice       Decimal         @db.Decimal(15, 2)
  taxRate         Decimal         @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal         @default(0) @db.Decimal(15, 2)
  amount          Decimal         @db.Decimal(15, 2)

  // Relations
  challan         DeliveryChallan @relation(fields: [challanId], references: [id], onDelete: Cascade)
  product         Product         @relation(fields: [productId], references: [id])

  @@index([challanId])
  @@index([productId])
}

model Invoice {
  id              String        @id @default(uuid())
  companyId       String
  customerId      String
  invoiceNumber   String
  invoiceDate     DateTime      @default(now())
  dueDate         DateTime?
  salesOrderId    String?
  challanId       String?
  shippingAddress String?       @db.Text
  subtotal        Decimal       @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal       @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal       @default(0) @db.Decimal(15, 2)
  total           Decimal       @default(0) @db.Decimal(15, 2)
  paidAmount      Decimal       @default(0) @db.Decimal(15, 2)
  balanceAmount   Decimal       @default(0) @db.Decimal(15, 2)
  paymentStatus   PaymentStatus @default(PENDING)
  status          DocumentStatus @default(DRAFT)
  notes           String?       @db.Text
  terms           String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       String?

  // Relations
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer      @relation(fields: [customerId], references: [id])
  salesOrder      SalesOrder?   @relation(fields: [salesOrderId], references: [id])
  challan         DeliveryChallan? @relation(fields: [challanId], references: [id])
  items           InvoiceItem[]
  receipts        Receipt[]

  @@unique([companyId, invoiceNumber])
  @@index([companyId])
  @@index([customerId])
  @@index([salesOrderId])
  @@index([invoiceDate])
  @@index([dueDate])
  @@index([paymentStatus])
}

model InvoiceItem {
  id              String   @id @default(uuid())
  invoiceId       String
  productId       String
  description     String?
  quantity        Decimal  @db.Decimal(15, 3)
  unitPrice       Decimal  @db.Decimal(15, 2)
  taxRate         Decimal  @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(15, 2)
  amount          Decimal  @db.Decimal(15, 2)

  // Relations
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id])

  @@index([invoiceId])
  @@index([productId])
}

model SalesReturn {
  id              String        @id @default(uuid())
  companyId       String
  customerId      String
  returnNumber    String
  returnDate      DateTime      @default(now())
  invoiceId       String?
  reason          String?       @db.Text
  subtotal        Decimal       @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal       @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal       @default(0) @db.Decimal(15, 2)
  total           Decimal       @default(0) @db.Decimal(15, 2)
  refundAmount    Decimal       @default(0) @db.Decimal(15, 2)
  status          DocumentStatus @default(DRAFT)
  notes           String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       String?
  approvedBy      String?
  approvedAt      DateTime?

  // Relations
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer      @relation(fields: [customerId], references: [id])
  items           SalesReturnItem[]

  @@unique([companyId, returnNumber])
  @@index([companyId])
  @@index([customerId])
  @@index([returnDate])
}

model SalesReturnItem {
  id              String      @id @default(uuid())
  returnId        String
  productId       String
  description     String?
  quantity        Decimal     @db.Decimal(15, 3)
  returnReason    String?
  unitPrice       Decimal     @db.Decimal(15, 2)
  taxRate         Decimal     @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal     @default(0) @db.Decimal(15, 2)
  amount          Decimal     @db.Decimal(15, 2)

  // Relations
  salesReturn     SalesReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)
  product         Product     @relation(fields: [productId], references: [id])

  @@index([returnId])
  @@index([productId])
}

// ==================== PAYMENT & RECEIPT MODULE ====================

model Payment {
  id              String        @id @default(uuid())
  companyId       String
  vendorId        String
  billId          String?
  paymentNumber   String
  paymentDate     DateTime      @default(now())
  paymentMethod   PaymentMethod @default(CASH)
  amount          Decimal       @db.Decimal(15, 2)
  referenceNo     String?
  bankName        String?
  chequeNo        String?
  chequeDate      DateTime?
  upiId           String?
  notes           String?       @db.Text
  status          PaymentStatus @default(PAID)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       String?

  // Relations
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor          Vendor        @relation(fields: [vendorId], references: [id])
  bill            Bill?         @relation(fields: [billId], references: [id])

  @@unique([companyId, paymentNumber])
  @@index([companyId])
  @@index([vendorId])
  @@index([billId])
  @@index([paymentDate])
}

model Receipt {
  id              String        @id @default(uuid())
  companyId       String
  customerId      String
  invoiceId       String?
  receiptNumber   String
  receiptDate     DateTime      @default(now())
  paymentMethod   PaymentMethod @default(CASH)
  amount          Decimal       @db.Decimal(15, 2)
  referenceNo     String?
  bankName        String?
  chequeNo        String?
  chequeDate      DateTime?
  upiId           String?
  notes           String?       @db.Text
  status          PaymentStatus @default(PAID)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       String?

  // Relations
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer      @relation(fields: [customerId], references: [id])
  invoice         Invoice?      @relation(fields: [invoiceId], references: [id])

  @@unique([companyId, receiptNumber])
  @@index([companyId])
  @@index([customerId])
  @@index([invoiceId])
  @@index([receiptDate])
}

// ==================== JOURNAL ENTRY MODULE ====================

model JournalEntry {
  id              String        @id @default(uuid())
  companyId       String
  entryNumber     String
  entryDate       DateTime      @default(now())
  entryType       String        @default("MANUAL")  // MANUAL, SYSTEM, ADJUSTMENT
  referenceType   String?       // e.g., "INVOICE", "BILL"
  referenceId     String?
  referenceNumber String?
  description     String?       @db.Text
  totalDebit      Decimal       @default(0) @db.Decimal(15, 2)
  totalCredit     Decimal       @default(0) @db.Decimal(15, 2)
  isPosted        Boolean       @default(false)
  postedAt        DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdBy       String?

  // Relations
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lines           JournalLine[]

  @@unique([companyId, entryNumber])
  @@index([companyId])
  @@index([entryDate])
  @@index([isPosted])
}

model JournalLine {
  id              String        @id @default(uuid())
  entryId         String
  accountId       String
  description     String?
  transactionType TransactionType
  amount          Decimal       @db.Decimal(15, 2)

  // Relations
  entry           JournalEntry  @relation(fields: [entryId], references: [id], onDelete: Cascade)
  account         Account       @relation(fields: [accountId], references: [id])

  @@index([entryId])
  @@index([accountId])
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  companyId   String?
  action      String   // CREATE, READ, UPDATE, DELETE
  resource    String   // e.g., "PRODUCT", "INVOICE"
  resourceId  String?
  oldValues   Json?
  newValues   Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())

  // Relations
  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@index([resource])
  @@index([timestamp])
}
